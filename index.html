<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mappa POI Interattiva</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
/* Stili di base */
html, body { 
    height: 100%; 
    margin: 0; 
    font-family: Arial, sans-serif; 
}
#map { 
    height: 100%; 
    width: 100%; 
}

/* Contenitore per elementi UI in alto */
#ui-container {
  position: absolute;
  top: 10px;
  width: 100%;
  pointer-events: none;
  z-index: 1000;
}

/* MODIFICATO: Google Search al centro in alto, reso responsivo */
#search-container {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  max-width: calc(100% - 120px); /* Vincolo per non sovrapporsi ai bottoni laterali */
  background: rgba(255,255,255,0.9);
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  padding: 6px 10px;
  pointer-events: auto;
}
/* MODIFICATO: Input di ricerca reso flessibile */
#pac-input { 
    width: 250px; 
    max-width: 100%; /* Permette all'input di restringersi */
    box-sizing: border-box; /* Assicura che padding e border non aumentino la larghezza totale */
    padding: 5px 8px; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    font-size: 14px; 
}

/* MODIFICATO: Stile per il pulsante di refresh, ora indipendente */
#refresh-container {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1001; /* Leggermente più alto per sicurezza */
  pointer-events: auto;
}

#refresh-btn {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 42px;
  height: 42px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  text-decoration: none;
  color: #333;
  font-size: 24px;
  border: 1px solid #ccc;
}

#refresh-btn:hover {
  background: #f4f4f4;
}


/* Selezione Località in basso a SINISTRA */
#location-container {
  position: absolute;
  bottom: 10px; 
  left: 10px;   
  background: rgba(255,255,255,0.9);
  border-radius: 6px;
  box-shadow: 0 1px 5px rgba(0,0,0,0.4);
  padding: 6px 10px;
  pointer-events: auto;
  z-index: 900; 
}
#select-localita { padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }

/* Contenitore per la legenda e il suo pulsante */
#legend-container {
  position: absolute;
  bottom: 10px;
  right: 10px; 
  z-index: 900;
  text-align: right;
}

/* Stile della legenda */
#legend {
  background: rgba(255, 255, 255, 0.9);
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 1px 5px rgba(0,0,0,0.4);
  pointer-events: auto;
  margin-top: 5px;
  display: none;
}

#legend.visible {
  display: block;
}

.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
  font-size: 14px;
}
.legend-color {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  margin-right: 8px;
  border: 1px solid #555;
}

/* Stili del Form Popup e Pulsanti */
.poi-form input, .poi-form textarea, .poi-form select {
  width: 100%; padding: 6px; margin: 4px 0; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box;
}
.poi-form textarea { resize: vertical; }

.btn { 
    display: inline-block; 
    padding: 6px 10px; 
    border-radius: 4px; 
    border: none; 
    cursor: pointer; 
    color: #fff; 
    text-decoration: none;
    margin-top: 8px;
    margin-right: 5px;
}
.btn.primary { background:#1976d2; }
.btn.secondary { background:#6c757d; }

.btn-delete { 
    background-color: #dc3545;
}
.btn-navigate {
    background-color: #28a745;
}
</style>
</head>
<body>

<div id="ui-container">
  <div id="search-container">
    <input id="pac-input" type="text" placeholder="Cerca un luogo..." />
  </div>
</div>

<!-- SPOSTATO: Il contenitore del pulsante di refresh ora è indipendente -->
<div id="refresh-container">
    <a href="javascript:location.reload();" id="refresh-btn" title="Aggiorna la pagina">
      &#x21BB; <!-- Codice Unicode per l'icona "freccia circolare" -->
    </a>
</div>

<div id="location-container">
  <select id="select-localita">
    <option value="">Seleziona Località</option>
  </select>
</div>

<div id="map"></div>

<div id="legend-container">
  <button id="toggle-legend-btn" class="btn secondary">Legenda</button>
  <div id="legend">
    <strong>Tipologie POI</strong>
    <div id="legend-content"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Il codice Javascript principale rimane invariato...
const GAS_URL = 'https://script.google.com/macros/s/AKfycbymiOChn9zDPibOCxS_ar3DdnenivPTVhBEJpCedGUlFydU2CiRni8zmpH7ZonYhxPd/exec';
let map, poiLayerGroup, tipologie = [];
let currentLocationMarker = null;
const DEFAULT_CENTER = [42.76030097166939, 11.114333399598166];
const DEFAULT_ZOOM = 15;

document.addEventListener('DOMContentLoaded', () => {
    const toggleLegendBtn = document.getElementById('toggle-legend-btn');
    const legend = document.getElementById('legend');
    
    toggleLegendBtn.addEventListener('click', () => {
        legend.classList.toggle('visible');
        if (legend.classList.contains('visible')) {
            toggleLegendBtn.textContent = 'Nascondi Legenda';
        } else {
            toggleLegendBtn.textContent = 'Mostra Legenda';
        }
    });
    toggleLegendBtn.textContent = 'Mostra Legenda';
});

// ---------------- MAPPA E UI ----------------
function initMap() {
  map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
  poiLayerGroup = L.layerGroup().addTo(map);

  showCurrentLocation();

  map.on('click', function(e) {
    openPoiForm({lat: e.latlng.lat, lng: e.latlng.lng, name: ''});
  });

  loadTipologie().then(() => {
    loadLocalita();
    loadPOI();
  });
}

// ... il resto del codice JavaScript rimane identico ...

// ---------------- POSIZIONE ATTUALE ----------------
function showCurrentLocation() {
    if (!navigator.geolocation) {
        console.log("Geolocalizzazione non supportata.");
        return;
    }
    navigator.geolocation.getCurrentPosition((position) => {
        const { latitude, longitude } = position.coords;
        if (currentLocationMarker) {
            poiLayerGroup.removeLayer(currentLocationMarker);
        }
        currentLocationMarker = L.circleMarker([latitude, longitude], {
            radius: 9, fillColor: '#007bff', color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9
        }).addTo(poiLayerGroup);
        currentLocationMarker.bindPopup(`<b>La tua Posizione</b>`).openPopup();
    }, (err) => {
        console.warn(`ERRORE (${err.code}): ${err.message}`);
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
}

// ---------------- GOOGLE PLACES ----------------
function initAutocomplete() {
  const input = document.getElementById("pac-input");
  const autocomplete = new google.maps.places.Autocomplete(input);
  autocomplete.addListener("place_changed", function () {
    const place = autocomplete.getPlace();
    if (!place.geometry) { alert("Nessun dettaglio disponibile per: '" + place.name + "'"); return; }
    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();
    map.setView([lat, lng], DEFAULT_ZOOM);
    openPoiForm({lat, lng, name: place.name});
  });
}

// ---------------- CARICAMENTO LOCALITA ----------------
async function loadLocalita() {
  try {
    const res = await fetch(`${GAS_URL}?action=listLocalita`);
    if (!res.ok) throw new Error(`Errore HTTP: ${res.status}`);
    const data = await res.json();
    const select = document.getElementById('select-localita');
    select.innerHTML = '<option value="">Seleziona Località</option>';
    data.forEach(l => {
      if(!l.Localita || !l.Coordinate) return;
      const option = document.createElement('option');
      option.value = l.Coordinate;
      option.textContent = l.Localita;
      select.appendChild(option);
    });
    select.addEventListener('change', (e) => {
      if (!e.target.value) { map.setView(DEFAULT_CENTER, DEFAULT_ZOOM); return; }
      const coords = e.target.value.split(',').map(Number);
      if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
        map.setView(coords, DEFAULT_ZOOM);
      }
    });
  } catch(e) { console.error("Errore caricamento località:", e); }
}

// ---------------- CARICAMENTO TIPLOGIE E LEGENDA ----------------
async function loadTipologie() {
  try {
    const res = await fetch(`${GAS_URL}?action=listTipologia`);
    if (!res.ok) throw new Error(`Errore HTTP: ${res.status}.`);
    const data = await res.json();
    tipologie = data.map(t => ({
      id: String(t.IDTipo).trim(),
      nome: t.Tipo,
      colore: t.Colore ? String(t.Colore).toLowerCase() : 'gray' 
    }));
    const legendContent = document.getElementById('legend-content');
    legendContent.innerHTML = ''; 
    if (tipologie.length === 0) { legendContent.innerHTML = '<p>Nessuna tipologia caricata.</p>'; return; }
    tipologie.forEach(t => {
      if (!t.nome || t.nome.trim() === '') return; 
      const div = document.createElement('div');
      div.className = 'legend-item';
      div.innerHTML = `<span class="legend-color" style="background-color: ${t.colore};"></span>${t.nome}`;
      legendContent.appendChild(div);
    });
  } catch(e) { 
      console.error("Errore caricamento tipologie:", e);
      document.getElementById('legend-content').innerHTML = `Errore caricamento tipologie.`;
  }
}

// ---------------- CARICAMENTO POI E MARKER ----------------
async function loadPOI() {
  try {
    const res = await fetch(`${GAS_URL}?action=listPOI`);
    if (!res.ok) throw new Error(`Errore HTTP: ${res.status}`);
    
    const data = await res.json();
    
    poiLayerGroup.eachLayer(layer => {
        if (layer !== currentLocationMarker) {
            poiLayerGroup.removeLayer(layer);
        }
    });

    data.forEach(p => {
      if (!p.Coordinate) return; 
      
      const coords = String(p.Coordinate).split(',').map(Number);
      if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
      
      const tipo = tipologie.find(t => t.id === String(p.IDTipo).trim());
      const markerColor = tipo ? tipo.colore : 'blue';
      const tipoNome = tipo ? tipo.nome : 'Sconosciuto';
      
      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${coords[0]},${coords[1]}`;

      let popupContent = `
        <b>${p.Name || 'Senza nome'}</b><br>
        Tipo: ${tipoNome}<br>
        Note: ${p.Note || 'Nessuna nota'}<br>
        ${p.Link ? `<a href="${p.Link}" target="_blank">Link di Riferimento</a><br>` : ''}
      `;

      let buttonsHtml = '<div>';
      buttonsHtml += `<a href="${googleMapsUrl}" target="_blank" class="btn btn-navigate">Invia a Maps</a>`;

      const hasValidId = p.IDLuoghi !== null && p.IDLuoghi !== undefined && String(p.IDLuoghi).trim() !== '';
      if (hasValidId) {
        buttonsHtml += `<button class="btn btn-delete" data-id="${p.IDLuoghi}">Elimina</button>`;
      }
      buttonsHtml += '</div>';
      popupContent += buttonsHtml;

      const marker = L.circleMarker(coords, {
          radius: 8, fillColor: markerColor, color: "#000",
          weight: 1, opacity: 1, fillOpacity: 0.8
      }).addTo(poiLayerGroup).bindPopup(popupContent);
      
      if (hasValidId) {
        marker.on('popupopen', () => {
            const deleteBtn = document.querySelector(`.btn-delete[data-id="${p.IDLuoghi}"]`);
            if (deleteBtn) {
              deleteBtn.addEventListener('click', () => {
                if (confirm(`Sei sicuro di voler eliminare il POI "${p.Name}"?`)) {
                    deletePOI(p.IDLuoghi); 
                }
              });
            }
        });
      }
    });
  } catch(e) { 
    console.error("Errore critico durante il caricamento dei POI:", e);
    alert("Non è stato possibile caricare i Punti di Interesse.");
  }
}

// ---------------- FORM PER NUOVO POI ----------------
function openPoiForm({lat, lng, name}) {
  const form = document.createElement('div');
  form.className = 'poi-form';
  const tipoOptions = tipologie.map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  form.innerHTML = `
    <label>Nome</label>
    <input id="form-name" type="text" value="${name || ''}" />
    <label>Tipo</label>
    <select id="form-tipologia">${tipoOptions}</select>
    <label>Note</label>
    <textarea id="form-note" rows="3"></textarea>
    <label>Link</label>
    <input id="form-link" type="text" placeholder="https://..." />
    <div style="margin-top:10px; text-align:right;">
      <button id="btn-canc" class="btn secondary">Annulla</button>
      <button id="btn-save" class="btn primary">Salva POI</button>
    </div>
  `;
  const popup = L.popup({maxWidth:360}).setLatLng([lat,lng]).setContent(form).openOn(map);
  document.getElementById('btn-canc').addEventListener('click', ()=>map.closePopup());
  document.getElementById('btn-save').addEventListener('click', async ()=>{
    const payload = {
      action: 'addPOI',
      Name: document.getElementById('form-name').value.trim(),
      Coordinate: `${lat.toFixed(6)},${lng.toFixed(6)}`,
      IDTipo: document.getElementById('form-tipologia').value,
      Note: document.getElementById('form-note').value.trim(),
      Link: document.getElementById('form-link').value.trim()
    };
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (res.status === 0 || res.ok) {
          alert('POI salvato con successo!'); 
      } else { throw new Error(`Errore HTTP: ${res.status}`); }
      map.closePopup();
      await loadPOI();
    } catch(e) { 
        console.error("Errore nel salvataggio:", e);
        alert('Errore salvataggio: ' + e.message); 
    }
  });
}

// ---------------- FUNZIONE DI ELIMINAZIONE ----------------
async function deletePOI(poiId) {
    try {
        const res = await fetch(GAS_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'deletePOI', ID: poiId })
        });
        if (res.status === 0 || res.ok) {
            alert('POI eliminato con successo!');
            map.closePopup();
            loadPOI();
        } else { throw new Error(`Errore HTTP: ${res.status}`); }
    } catch (e) {
        console.error("Errore durante l'eliminazione:", e);
        alert('Errore durante l\'eliminazione: ' + e.message);
    }
}

// ---------------- INIZIALIZZAZIONE ----------------
window.initMapAndAutocomplete = function() {
  initMap();
  initAutocomplete();
}
</script>

<script async
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqyDLI3nLGU6RmLaollsDwQN9khS0m02U&libraries=places&callback=initMapAndAutocomplete">
</script>

</body>
</html>
